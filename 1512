using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using Barclays.Alm.Ramebbo.Contracts.CostManagement;
using Barclays.Alm.Ramebbo.Contracts.Services;
using Barclays.Alm.Ramebbo.Contracts.Domain;
// Logging 的命名空间你自己对一下，如果不叫这个就改掉
using Barclays.Alm.Ramebbo.Contracts.Logging;

namespace Barclays.Alm.Ramebbo.Infrastructure.Cache
{
    /// <summary>
    /// Caches cost data in memory to reduce calls to AWS Cost Explorer
    /// and avoid unnecessary latency / charges.
    /// </summary>
    public class CostExplorerCache : ICostExplorerCache
    {
        private readonly IAwsConsoleService _awsConsoleService;
        private readonly ILoggingManager _logger;

        // 内存缓存：key = "MONTHLY" / "DAILY" / "HOURLY"
        private readonly Dictionary<string, CachedCostEntry> _cache =
            new Dictionary<string, CachedCostEntry>();

        // 先写死缓存时长，后面你可以改成从配置读取
        private static readonly TimeSpan MonthlyCacheDuration = TimeSpan.FromHours(24); // 1 天
        private static readonly TimeSpan DailyCacheDuration   = TimeSpan.FromHours(6);  // 6 小时
        private static readonly TimeSpan HourlyCacheDuration  = TimeSpan.FromHours(1);  // 1 小时

        private class CachedCostEntry
        {
            public List<CostData> Data { get; set; }
            public DateTime CachedAtUtc { get; set; }
        }

        public CostExplorerCache(
            IAwsConsoleService awsConsoleService,
            ILoggingManager logger)
        {
            _awsConsoleService = awsConsoleService ?? throw new ArgumentNullException(nameof(awsConsoleService));
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        }

        // ======================= Public API =======================

        public Task<List<CostData>> GetMonthlyCostDataAsync()
        {
            return GetOrCreateAsync(
                cacheKey: "MONTHLY",
                duration: MonthlyCacheDuration,
                granularity: "MONTHLY");
        }

        public Task<List<CostData>> GetDailyCostDataAsync()
        {
            return GetOrCreateAsync(
                cacheKey: "DAILY",
                duration: DailyCacheDuration,
                granularity: "DAILY");
        }

        public Task<List<CostData>> GetHourlyCostDataAsync()
        {
            return GetOrCreateAsync(
                cacheKey: "HOURLY",
                duration: HourlyCacheDuration,
                granularity: "HOURLY");
        }

        // ======================= Core cache logic =======================

        private async Task<List<CostData>> GetOrCreateAsync(
            string cacheKey,
            TimeSpan duration,
            string granularity)
        {
            if (_cache.TryGetValue(cacheKey, out var entry))
            {
                if (!IsExpired(entry, duration))
                {
                    _logger.Info($"Cost cache HIT for key '{cacheKey}'.");
                    return entry.Data;
                }

                _logger.Info($"Cost cache EXPIRED for key '{cacheKey}'. Refreshing...");
            }
            else
            {
                _logger.Info($"Cost cache MISS for key '{cacheKey}'. Fetching from AWS...");
            }

            // 这里调用你们已经成熟的取 cost 方法
            var ec2Instances = await _awsConsoleService
                .GetEc2InstancesWithCostAsync(granularity)
                .ConfigureAwait(false);

            var costDataList = MapEc2ListToCostData(ec2Instances, granularity);

            _cache[cacheKey] = new CachedCostEntry
            {
                Data = costDataList,
                CachedAtUtc = DateTime.UtcNow
            };

            return costDataList;
        }

        private static bool IsExpired(CachedCostEntry entry, TimeSpan duration)
        {
            var age = DateTime.UtcNow - entry.CachedAtUtc;
            return age >= duration;
        }

        // ======================= Mapping =======================

        /// <summary>
        /// 将 IList&lt;IEc2&gt; 展开为前端 Raw Cost Data 需要的 List&lt;CostData&gt;。
        /// 每个 Ec2 中的每一条 IEc2CostData，都映射成一行 CostData。
        /// </summary>
        private List<CostData> MapEc2ListToCostData(
            IList<IEc2> ec2Instances,
            string granularity)
        {
            var result = new List<CostData>();

            if (ec2Instances == null)
            {
                return result;
            }

            var gran = ParseGranularity(granularity);

            foreach (var ec2 in ec2Instances)
            {
                if (ec2 == null || ec2.CostData == null)
                {
                    continue;
                }

                foreach (var costItem in ec2.CostData)
                {
                    // 这里假设 IEc2CostData 里有：
                    //  - double Cost
                    //  - DateTime StartDate
                    //  - DateTime EndDate
                    //
                    // 控制台里你看到的是：
                    //  { cost: 0.8174, ec2InstanceId: 'i-xxx', startDate: '00:00', endDate: '01:00', nodeName: 'uat3.account_gateway', ... }
                    // 所以 C# 侧一定有对应属性，只是名字可能略有不同：
                    // 如果叫 From / To / Amount 之类，你就在下面改一下。

                    var costData = new CostData
                    {
                        // 标识 / 维度信息（来自 Ec2 实例）
                        InstanceId         = ec2.Id,
                        NodeName           = ec2.NodeName,
                        Name               = ec2.Name,
                        AmazonInstanceType = ec2.AmazonInstanceType,  // 如果没有这个属性，换成正确的字段

                        Environment        = ec2.Environment,
                        SandBox            = ec2.AppEnvironment,      // 如果将来有真正的 Sandbox 字段，再改成 Sandbox

                        // 时间粒度
                        Granularity        = gran,

                        // 成本信息（来自 IEc2CostData）
                        Cost               = (decimal)costItem.Cost,
                        StartDate          = costItem.StartDate,
                        EndDate            = costItem.EndDate,

                        // 缓存元数据（方便调试用，真正过期由外层 Duration 控制）
                        CachedAt           = DateTime.UtcNow,
                        ExpiresAt          = DateTime.MinValue
                    };

                    // 如果你想要一个唯一的 Id，可以这样拼一下：
                    costData.Id = $"{costData.InstanceId}-{costData.StartDate:yyyyMMddHHmm}-{granularity}";

                    result.Add(costData);
                }
            }

            return result;
        }

        private CostGranularity ParseGranularity(string granularity)
        {
            return granularity switch
            {
                "MONTHLY" => CostGranularity.MONTHLY,
                "DAILY"   => CostGranularity.DAILY,
                "HOURLY"  => CostGranularity.HOURLY,
                _         => CostGranularity.DAILY
            };
        }
    }
}
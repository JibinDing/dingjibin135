using Moq;
using NUnit.Framework;
using System;
using System.Collections.Generic;

[TestFixture]
public class ControlCheckManagerServiceTests
{
    [Test]
    public void DeleteControlCheckFile_WhenStatusIsOnline_ShouldSetArchivedAndUpdateFields()
    {
        // Arrange dependencies
        var loggerMock = new Mock<ILoggingManager>();
        var appEnvMock = new Mock<IGeneralConfiguration>();
        var httpFactoryMock = new Mock<IHttpClientFactoryService>();
        var fileProxyMock = new Mock<IFileProxy>();
        var archiveManagerMock = new Mock<IArchiveManager>();

        // IMPORTANT: Force DeleteAllFiles() to return FALSE
        // This happens when Exists() returns false for all paths.
        fileProxyMock.Setup(fp => fp.Exists(It.IsAny<string>()))
                     .Returns(false);

        // Construct service with mocked dependencies
        var service = new ControlCheckManagerService(
            loggerMock.Object,
            appEnvMock.Object,
            httpFactoryMock.Object,
            fileProxyMock.Object,
            archiveManagerMock.Object
        );

        var summary = new ControlCheckSummary
        {
            ControlCheckId = "Test123",
            ControlStatus = CubeStatus.Online  // Must be Online to enter the IF block
        };

        var returnList = new List<ControlCheckResultStatus>();
        var userName = "unitTestUser";

        // Act
        service.DeleteControlCheckFile(summary, returnList, userName);

        // Assert â€” the yellow Sonar-highlighted lines
        Assert.AreEqual(CubeStatus.Archived, summary.ControlStatus);
        Assert.AreEqual(userName, summary.UpdatedBy);
        Assert.AreNotEqual(default(DateTime), summary.UpdatedDate);

        // Optional: verify logger was called
        loggerMock.Verify(l => l.Info(It.IsAny<string>()), Times.AtLeastOnce);
    }
}